# TAD-PHP

A simple PHP class to interacts with ZK Time & Attendance Devices.

##About

TAD: It's a class that implements an interface to interacts with ZK Time & Atttendance devices, using SOAP api presents in those devices.

Documentation found about ZK SOAP api is very limited or poor, however TAD class implements most SOAP functions supported by ZK devices. Specifically TAD class exposes the following 16 methods:

```php
get_date, get_att_log, get_user_info, get_all_user_info, get_user_template, get_combination, get_option, set_date, set_user_info, set_user_template, delete_user, delete_template, delete_data, delete_user_password, refresh_db, restart.
```
There are some SOAP functions that it's suppossed,  according to the official docs (which incidentally it's very limited and so poor!!!) must show an expected behaviour, but when they are invoked don't work like it's expected, so they become useless (e.g. Restart SOAP call). For these situations, TAD class integrates a PHP class named [PHP_ZKLib](http://dnaextrim.github.io/php_zklib/) (founded after googling for hours, and hours, and hours!!!). This class take a different approach to "talk to device": it uses UDP protocol at device standard port 4370.

PHP_ZKLib class it's been fully integrated, after a refactoring process to take out all duplicated code (DRY).

PHP_ZKLib class exposes the following 7 methods:

```php
set_date, enable_device, disable_device, restart, poweroff, get_free_sizes, delete_admin
```

For practical purposes, you don't have to be worried about when to use TAD class or PHP_ZKLib class because you only have to get a TAD instance (as shown below) and call any of methods available. The class decides about when run the method invoked using TAD class or PHP_ZKLib class.

##Requirements
* Any flavour of PHP 5.3+
* PHPUnit to execute the test suite (optional).

##Getting started
###Class instantiation
First, instantiate a TADFactory object, then use it to create a TAD object.
```php
<?php
  $tad_factory = new TADFactory(['ip'=>'192.168.0.1']);
  $tad = $tad_factory->get_instance();
```
Or you can get a TAD object in one single step (valid only in PHP 5.4+):
```php
<?php
  $tad = (new TADFactory(['ip'=>'192.168.0.1']))->get_instance();
```
You can customize TAD object traits passing an options array:
```php
<?php
  $options = [
    'ip' => '192.168.0.1',   // '169.254.0.1' by default (totally useless!!!).
    'internal_id' => 100,    // 1 by default.
    'com_key' => 123,        // 0 by default.
    'description' => 'TAD1', // 'N/A' by default.
    'soap_port' => 8080,     // 80 by default,
    'udp_port' => 20000      // 4370 by default.
  ];
  
  $tad_factory = new TADFactory($options);
  $tad = $tad_factory->get_instance();  
```
##TAD API
SOAP api is implemented by TADSoap class. All methods that use UDP Protocol are implemented by PHP_ZKLib class. Even Though you have 2 classes, you do not have to be worried about the method is calling using SOAP api or through PHP_ZKLib. You've got a single interface.

Some methods needs you set up some parameters prior calling them. TAD class uses associative arrays as way to pass params to the methods. Using associative arrays is more "verbose" way and help you to remember wich params you have to pass.

Valid params supported by TAD class are:

```
com_key, pin, time, template, name, password, group, privilege, card, pin2, tz1, tz2, tz3, finger_id, option_name, date, size, valid, value
```

As you can see, params names are so intuitive and easy to remember.

######Note: All examples shown below asusmes $tad variable holds a TAD object.

###Getting and Setting Date and Time

```php
// Gettting current time and date
$dt = $tad->get_date();

// Setting date device to '2014-01-01' (time will be set to now!)
$response = $tad->set_date(['date'=>'2014-01-01']);

// Setting time device to '12:30:15' (date will be set to today!)
$response = $tad->set_date(['time'=>'12:30:15']);

// Setting device date & time
$response = $tad->set_date(['date'=>'2014-01-01', 'time'=>'12:30:15']);

// Setting device date & time to now.
$response = $tad->set_date();
```
###Getting attendance logs
You can retrieve attendance logs for all user or for one:
```php
// Getting attendance logs from all users.
$logs = $tad->get_att_log();

// Getting attendance logs from one user.
$logs = $tad->get_att_log(['pin'=>123]);
```
###Getting information about users.
You can get all information about a single user or all users. The information you can get include:

* PIN: Internal user ID (this is an id generated by the device).
* Name: User's name.
* Password: Password used to check in/out.
* Card: Card number (relevant if you device supports RFID technology).
* Privilege: User rol (1: regular user, 2: enroller, 6: admin and 14: superadmin)
* Group: User's group privilege.
* PIN2: Personal identity number (this is an id you can set according your needs).
* TZ1: User time zone 1.
* TZ2: User time zone 2.
* TZ3: User time zone 3:

```php
// Getting info from a specific user.
$user_info = $tad->get_user_info(['pin'=>123]);

// Getting info from all users.
$all_user_info = $tad->get_all_user_info();
```
###Creating / Updating users
TAD class allows you to register new users in the device or even you can update (change) information about an user already registered. However to achieve this, TAD class needs to delete the user (of course this applies when you are updating user's information) and then creates the user. Maybe this is not the best way to do that, but if TAD just calls the method to create a user, it will be created as many times as you call the create user method.

If you look into PHP_ZKLib code, you'll see a method to create / update users. However, when you call that method, it generates a PIN code (not PIN2 code) in a way that if that code already exists in the device, it refuses to create the user. This is a method I would like to modify to work properly but I don't know how PIN code is created.

In the meantime, TAD class uses delete and create SOAP calls. Of course, to make things easy for you, you have to call just 1 method.
```php
// We are creating a superadmin user named 'Foo Bar' with a PIN = 123 and password = 4321.
$r = $tad->set_user_info([
    'pin' => 123,
    'name'=> 'Foo Bar',
    'privilege'=> 14,
    'password' => 4321
]);
```
######Note: The way TAD class creates / updates users has one big concern you have to be aware. The user's fingerprints stored (templates) are lost!!!, so it is necessary to save them prior you call set_user_info() method.

###Uploading user's fingerprints
The device uses an algorithm to encode fingerprints called "BioBridge" and it has 2 flavors: VX 9.0 and the new one VX 10.0. According the documentation, VX 10.0 generates shorter encoded fingerprints and it's faster when the device has to make searchings for a fingerprint match process. However, TAD class exposes a method to upload fingerprints but it works only when device is configured to use the old BioBridge VX 9.0 algorithm. When device uses VX 10.0 algorithm, the machine freezes!!!. When asked to ZK Software forum, the answer got was: "It has to work with any biobridge version. Check your code!".  Any help about this, would be appreciated.

```php
/** Setting a user template (fingerprint).
 * 
 * You can upload until 10 templates per user. You have to use 'finger_id' param to indicates
 * wich finger print you are uploading to.
 * 
 * Till now, this method only works with VX 9.0 BioBridge algorithm :-(. Any help
 * arround this issue will be appreciated. 
 */
 
// The folowing string represents a fingerprint encoded using BioBridge algorithm VX 9.0
$template1_vx9 = "ocosgoulTUEdNKVRwRQ0I27BDTEkdMEONK9KQQunMVSBK6VPLEENk9MwgQ+DP3PBC1FTXEEG4ihpQQQ3vFQBO4K+WwERYilHAQ8ztktBEBbKQ0ELDtJrwQ7dqCiBCz+/IgEGKrBjQQhEO0zBFQNDQYEKFbhrQQdLF1wBDxclfUELMNFXwQRvvmHBCslKUAEZfU1OQRzmIU5BXRW0eoEKPMltgQnQGUyBJQSfRIEUSzIdAQ45l3gBByHUTMEJ5yVhQQmi0UZBFHvYPUEGeKxTAQ6rFGNBCIYURoEOZS9VwR+1M4RoE5m0DRUTF8DHd6HdqxHAxWmj393M28DDX2FkanKi/t7LGsDCWqGarmt1BaL/25nAwVaiipu/cgcQGKG6mcDBU6KYmr5wChQcobmJIsDBUKKJmZ1uExyi+ZaYwMFMgU2CQCSinYdnJsDBR4Ghl3Q4owa3dnfAwUamdlZlR5p2Zi7AwUSndERlfOpWZlfAwUOiQzVkLDhDopRUVTLAwT2iQ0ZjIzVMolNFRcDBN6I0ZlQebVaiEjRVwMEyolVVUxVxXKEBRUTAwS+iZVYyD3JhoQJFTMDBLKJlVUIKcWShBVVTwMIkoWVkFQhyaaEVZ1rAwh6hVlUPAW+iNGd3wMIToWdlBnWiRWZ3aMDDCqRmZjRpZmrAxASjd2Vnh2/gAA==";

$template1_data = [
  'pin' => 123,
  'finger_id' => 0, // First fingerprint has 0 as index.
  'size' => 514,    // Be careful, this is not string length of $template1_vx9 var.
  'valid' => 1,
  'template' => $template1_vx9
];

$tad->set_user_template( $template1_data );
```

###Deleting user's fingerprints
When you have to delete user's fingerprints, you delete all of them. You cannot delete fingerprint one by one.

```php
// Delete all fingerprints (template) for user with PIN = 123.
$tad->delete_template(['pin'=>123]);
```

###Deleting user's passwords
```php
// Delete password for user with PIN = 123.
$tad->delete_user_password(['pin'=>123]);
```

###Deleting users
```php
/// Delete user with PIN = 123.
$tad->delete_user(['pin'=>123]);
```

###Deleting admin users
From the device point of view, users that have a privilege level not equal to 0, are considered admin users, so this method enables you wipe them out with one single step.
```php
$tad->delete_admin();
```

###Clearing out data from device
You can clear information from device according a code you specify.

Code meaning:

1: clear all device data, 2: clear all users templates and 3: clear all attendance logs.
```php
// Delete all attendance logs stored.
$tad->delete_data(['value'=>3]);
```

###Getting some statistics from the device.
You can get some valuable statistics about your device including:

 * Space available for templates. 
 * Space available for attendance logs.
 * Total storage capacity for attendance logs.
 * Total storage capacity for user templates.
 * Total users stored
 * Total user passwords stored.
 * Total attendance logs stored.
 * Total templates stored. 

```php
// Get some device statistics.
$fs = $tad->get_free_sizes();
```
###Disabling / Enabling the device
Sometimes you need to lock device's screen and keypad to prevent users can use it. You can disable the device and when you want to get it back working, you have to enable it.
```php
// Disabling device.
$tad->disable_device();

...

// Enabling device.
$tad->enable_device();
```

###Restarting / Shutting down the device.
```php
// Restart the device!!!
$tad->restart();

...

// Shut down the device!!!
$tad->poweroff();
```

##A little word about TAD Helpers
Besides TAD class, you'll find another class named TADHelpers, as it's name suggests, that has several methods to help you with some common functions.

###Filtering attendance logs by date
As you saw above, you can get attendance logs from the device using method get_att_logs(). However, you get all attendance logs. As much as you can reduce resultset specifying a user PIN Id.

What if you want to get just attendance logs (for 1 user or all users) that meet a date criteria?. Well, you can get it!!!.
```php
// Get attendance logs for all users;
$att_logs = $tad->get_att_logs();

// Now, you want filter the resulset to get att logs between '2014-01-10' and '2014-03-20'.
$filtered_att_logs = TADHelpers::filter_xml_by_date( [
	'start_date' => '2014-01-10',
    'end_date' => '2014-03-20
] );
```

Of course as you can suppose, the devices gives you all attendance logs (it has not a function to filter results by date!!!). 

TADHelper class offers filter_xml_by_date() method to process the whole resulset.

###Don't want to fight with XML?, ..., just don't do it
TAD Class always returns responses in XML format, that it is it's behavior!. TADHelper class offers you methods to transform XML to JSON or even to Array.

```php
// Get attendance logs from user with PIN = 123.
$att_logs = $tad->get_att_log( ['pin'=>123] ); // You get an XML response.

// Let's transform XML response into JSON
$json_att_logs = TADHelpers::xml_to_json($att_logs);

// Get crazy!!!, let's transform XML response into array.
$att_logs_array = TADHelpers::xml_to_array($att_logs).
```
##Todo
TAD class is not perfect!!!. As mentioned at the beggining, it's been developed after hours, and hours, and hours of googling and it's been tested using just Fingertec Q2i Time & attendance device (that it's I have in my work), so it's possible that you can find errors when you use it with others devices or even you can find better ways to do the things. For that reason, there are some things to do:

* Make set_user_info() method works with BioBridge VX 10.0 algorithm.
* Find out how to customize the PIN code generation in the PHP_ZKLib zk_set_user_info() method.
* Test TAD method get_option(). This method allows you getting detailed information about the device, but it's necessary to set it's argument to a valid option name. However, these names are not available, and according to documentation ZK Software they will give you all options names but you have to pay for it.
* Enhance PHP_ZKLib to allow more sophisticated functions like uploading user's photo for example.

##Author
My name is [Jorge Cobis](<mailto:jcobis@gmail.com>) - <http://twitter.com/cobisja>, and I'm a amateur developer. I love coding using Ruby and PHP.

By the way, I'm from Venezuela :-)

##License
TAD-PHP s licensed under the MIT License - see the LICENSE file for details.

##Contributing
Feel free to contribute!!!. Welcome aboard!!!